<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Nhân viên - XYZ Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .role-badge { font-size: 0.85em; padding: 5px 10px; border-radius: 20px; }
        .badge-admin { background-color: #722ed1; color: white; } /* Màu tím cho Admin */
        .badge-staff { background-color: #1890ff; color: white; } /* Màu xanh cho Staff */
        .status-active { color: green; font-weight: bold; }
        .status-locked { color: red; font-weight: bold; }
        .loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); display: none; justify-content: center; align-items: center; z-index: 9999; }
    </style>
</head>
<body>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary"><i class="fas fa-user-shield"></i> Quản Lý Nhân Viên</h2>
        <button class="btn btn-success" onclick="openModal('ADD')">
            <i class="fas fa-plus-circle"></i> Tạo Nhân Viên Mới
        </button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Tên Đăng Nhập</th>
                        <th>Họ và Tên</th>
                        <th>Số Điện Thoại</th>
                        <th>Vai Trò</th>
                        <th>Trạng Thái</th>
                        <th class="text-center">Hành Động</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle">Thêm Nhân Viên</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    
                    <div class="mb-3">
                        <label>Tên đăng nhập <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="username" required>
                        <small class="text-muted" id="usernameHint">Không thể thay đổi sau khi tạo.</small>
                    </div>

                    <div class="mb-3">
                        <label>Mật khẩu</label>
                        <input type="password" class="form-control" id="password" placeholder="Nhập để đổi mật khẩu mới...">
                        <small class="text-muted" id="passwordHint">Để trống nếu không muốn đổi pass.</small>
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label>Họ và Tên</label>
                            <input type="text" class="form-control" id="fullName" required>
                        </div>
                        <div class="col-6 mb-3">
                            <label>SĐT</label>
                            <input type="text" class="form-control" id="phoneNumber">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label>Vai trò (Role)</label>
                        <select class="form-select" id="roleId">
                            <option value="1">Admin (Quản trị viên)</option> 
                            <option value="2">Staff (Nhân viên bán hàng)</option>
                            <option value="6">Kho (Thủ kho)</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">Lưu Lại</button>
            </div>
        </div>
    </div>
</div>

<div class="loading" id="loadingSpinner">
    <div class="spinner-border text-primary" role="status"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_BASE = 'http://web-quan-ly-ban-hang.railway.internal';
    axios.defaults.withCredentials = true; // QUAN TRỌNG
    const modalElement = new bootstrap.Modal(document.getElementById('userModal'));

    // --- 1. LOAD DANH SÁCH USER ---
    async function fetchUsers() {
        showLoading(true);
        try {
            const res = await axios.get(`${API_BASE}/user/list`);
            renderTable(res.data);
        } catch (error) {
            console.error(error);
            if (error.response?.status === 403) {
                alert("Bạn không có quyền truy cập trang này!");
                window.location.href = 'pos.html'; // Đá về trang bán hàng
            } else if (error.response?.status === 401) {
                window.location.href = 'login.html';
            }
        } finally {
            showLoading(false);
        }
    }

    // --- 2. RENDER BẢNG ---
    function renderTable(users) {
        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = '';

        users.forEach(user => {
            // Xác định Role để tô màu
            const roleName = user.role ? user.role.roleName : 'N/A';
            const roleBadge = roleName === 'ADMIN' ? 'badge-admin' : 'badge-staff';
            
            // Trạng thái
            const statusHtml = user.status 
                ? '<span class="status-active"><i class="fas fa-check-circle"></i> Hoạt động</span>' 
                : '<span class="status-locked"><i class="fas fa-lock"></i> Đã khóa</span>';

            const btnLockLabel = user.status ? 'Khóa' : 'Mở';
            const btnLockColor = user.status ? 'btn-outline-danger' : 'btn-outline-success';
            const btnLockIcon = user.status ? 'fa-lock' : 'fa-unlock';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${user.userId}</td>
                <td class="fw-bold">${user.username}</td>
                <td>${user.fullName || '-'}</td>
                <td>${user.phoneNumber || '-'}</td>
                <td><span class="role-badge ${roleBadge}">${roleName}</span></td>
                <td>${statusHtml}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-primary me-1" onclick='openModal("EDIT", ${JSON.stringify(user)})'>
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm ${btnLockColor}" onclick="toggleStatus(${user.userId})">
                        <i class="fas ${btnLockIcon}"></i> ${btnLockLabel}
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- 3. MỞ MODAL ---
    function openModal(mode, user = null) {
        document.getElementById('userForm').reset();
        const title = document.getElementById('modalTitle');
        const usernameInput = document.getElementById('username');
        const passwordHint = document.getElementById('passwordHint');

        if (mode === 'ADD') {
            title.innerText = "Tạo Nhân Viên Mới";
            document.getElementById('userId').value = '';
            usernameInput.disabled = false;
            passwordHint.innerText = "Bắt buộc nhập cho user mới.";
        } else {
            title.innerText = "Cập Nhật Nhân Viên: " + user.username;
            document.getElementById('userId').value = user.userId;
            
            usernameInput.value = user.username;
            usernameInput.disabled = true; // Không cho sửa username
            
            document.getElementById('fullName').value = user.fullName;
            document.getElementById('phoneNumber').value = user.phoneNumber;
            
            // Set select role (Cần đảm bảo value option khớp RoleID trong DB)
            if(user.role) {
                document.getElementById('roleId').value = user.role.roleId;
            }

            passwordHint.innerText = "Để trống nếu không muốn đổi mật khẩu.";
        }
        modalElement.show();
    }

    // --- 4. LƯU (THÊM / SỬA) ---
    async function saveUser() {
        const id = document.getElementById('userId').value;
        const roleId = document.getElementById('roleId').value;
        
        const data = {
            username: document.getElementById('username').value,
            passwordHash: document.getElementById('password').value, // Backend sẽ check nếu rỗng
            fullName: document.getElementById('fullName').value,
            phoneNumber: document.getElementById('phoneNumber').value
        };

        showLoading(true);
        try {
            if (id) {
                // Sửa
                await axios.put(`${API_BASE}/user/update/${id}?roleId=${roleId}`, data);
            } else {
                // Thêm mới (Cần check pass rỗng)
                if (!data.passwordHash) {
                    alert("Vui lòng nhập mật khẩu cho nhân viên mới!");
                    showLoading(false);
                    return;
                }
                await axios.post(`${API_BASE}/user/create?roleId=${roleId}`, data);
            }
            
            alert("Thành công!");
            modalElement.hide();
            fetchUsers();

        } catch (error) {
            alert("Lỗi: " + (error.response?.data || error.message));
        } finally {
            showLoading(false);
        }
    }

    // --- 5. KHÓA / MỞ KHÓA ---
    async function toggleStatus(id) {
        if (!confirm("Bạn có chắc muốn thay đổi trạng thái tài khoản này?")) return;
        
        showLoading(true);
        try {
            await axios.post(`${API_BASE}/user/toggle-status/${id}`);
            fetchUsers();
        } catch (error) {
            alert("Lỗi: " + error.message);
        } finally {
            showLoading(false);
        }
    }

    function showLoading(show) {
        document.getElementById('loadingSpinner').style.display = show ? 'flex' : 'none';
    }

    // Chạy khi tải trang
    document.addEventListener('DOMContentLoaded', fetchUsers);
</script>

</body>
</html>