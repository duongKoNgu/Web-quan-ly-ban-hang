<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS - Hệ thống quản lý bán hàng XYZ</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        /* --- CSS GIỮ NGUYÊN --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
        }

        body {
            background-color: #f0f2f5;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .left-section {
            flex: 7;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #ddd;
            background: #fff;
        }

        .header-bar {
            padding: 15px;
            background: #1890ff;
            color: white;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-box {
            flex: 1;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 35px 10px 15px;
            border-radius: 20px;
            border: none;
            outline: none;
        }

        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .category-tabs {
            padding: 10px 15px;
            background: #e6f7ff;
            display: flex;
            gap: 10px;
            overflow-x: auto;
        }

        .cat-btn {
            padding: 8px 16px;
            border: 1px solid #1890ff;
            border-radius: 20px;
            background: white;
            color: #1890ff;
            cursor: pointer;
            white-space: nowrap;
            transition: 0.3s;
        }

        .cat-btn.active,
        .cat-btn:hover {
            background: #1890ff;
            color: white;
        }

        .product-grid {
            padding: 15px;
            flex: 1;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            align-content: start;
        }

        .product-card {
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            background: white;
        }

        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .product-img {
            height: 120px;
            width: 100%;
            background-color: #eee;
            object-fit: cover;
        }

        .product-info {
            padding: 10px;
        }

        .product-name {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 5px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            height: 34px;
        }

        .product-price {
            color: #d48806;
            font-weight: bold;
            font-size: 15px;
        }

        .right-section {
            flex: 3;
            display: flex;
            flex-direction: column;
            background: #fff;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.05);
        }

        .cart-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #fafafa;
        }

        .customer-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .cart-items-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px dashed #eee;
            background: #fff;
        }

        .item-left {
            flex: 1;
        }

        .item-name {
            font-size: 14px;
            font-weight: 500;
        }

        .item-price {
            font-size: 12px;
            color: #888;
        }

        .item-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .qty-btn {
            width: 24px;
            height: 24px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qty-btn:hover {
            background: #f0f0f0;
        }

        .remove-btn {
            color: #ff4d4f;
            cursor: pointer;
            margin-left: 10px;
        }

        .cart-footer {
            padding: 15px;
            border-top: 1px solid #eee;
            background: #fafafa;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 18px;
            font-weight: bold;
            color: #1890ff;
        }

        .discount-input {
            width: 60px;
            text-align: right;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
        }

        .btn-pay {
            background: #1890ff;
            color: white;
        }

        .btn-pay:hover {
            background: #096dd9;
        }

        .btn-cancel {
            background: #ff4d4f;
            color: white;
        }

        .btn-cancel:hover {
            background: #cf1322;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="loading" id="loadingSpinner">
            <i class="fas fa-spinner fa-spin fa-3x text-primary"></i>
        </div>

        <div class="left-section">
            <div class="header-bar">
                <h3>XYZ STORE</h3>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Tìm sản phẩm (F3)..." onkeyup="handleSearch()">
                    <i class="fas fa-search"></i>
                </div>
            </div>

            <div class="category-tabs">
                <button class="cat-btn active" onclick="filterCategory('all')">Tất cả</button>
                <button class="cat-btn" onclick="filterCategory(1)">Cà phê</button>
                <button class="cat-btn" onclick="filterCategory(2)">Trà sữa</button>
                <button class="cat-btn" onclick="filterCategory(3)">Đồ ăn vặt</button>
            </div>

            <div class="product-grid" id="productGrid"></div>
        </div>

        <div class="right-section">
            <div class="cart-header">
                <h4 style="margin-bottom: 10px;">Thông tin đơn hàng</h4>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="customerPhone" class="customer-input" placeholder="Nhập SĐT khách hàng..."
                        onblur="lookupCustomer()">
                    <button style="height: 34px; width: 34px; cursor: pointer;" onclick="lookupCustomer()"
                        title="Tìm khách hàng"><i class="fas fa-search"></i></button>
                </div>
                <div style="font-size: 13px; margin-top: 5px;">
                    <i class="fas fa-user"></i> <span id="customerNameDisplay"
                        style="font-weight: bold; color: #1890ff;">Khách lẻ</span>
                    <span id="customerPointsDisplay" style="color: #d48806; font-size: 12px; margin-left: 5px;"></span>
                </div>
            </div>

            <div class="cart-items-container" id="cartItems">
                <div style="text-align: center; color: #999; margin-top: 50px;">
                    Chưa có sản phẩm nào
                </div>
            </div>

            <div class="cart-footer">
                <div class="summary-row">
                    <span>Tạm tính:</span>
                    <span id="subTotal">0 ₫</span>
                </div>
                <div class="summary-row">
                    <span>Giảm giá (%):</span>
                    <input type="number" id="discountInput" class="discount-input" value="0" min="0" max="100"
                        onchange="calculateTotal()">
                </div>
                <div class="total-row">
                    <span>TỔNG CỘNG:</span>
                    <span id="grandTotal">0 ₫</span>
                </div>

                <div class="btn-group">
                    <button class="btn btn-cancel" onclick="clearCart()">Hủy</button>
                    <button class="btn btn-pay" onclick="checkout()">Thanh toán</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Copy y chang dòng này
        const API_BASE = 'https://web-quan-ly-ban-hang-production.up.railway.app';
        axios.defaults.withCredentials = true;

        let allProducts = [];
        let cart = [];

        // SỬA 4: Biến lưu ID khách hàng đã tìm thấy
        let currentCustomerId = null;

        // --- 1. LOAD SẢN PHẨM ---
        async function fetchProductsFromAPI() {
            document.getElementById('loadingSpinner').style.display = 'flex';
            try {
                const res = await axios.get(`${API_BASE}/product/list?page=0&size=100`);
                allProducts = res.data.content;
                renderProducts(allProducts);
            } catch (error) {
                console.error(error);
                if (error.response && error.response.status === 401) {
                    alert("Vui lòng đăng nhập hệ thống trước!");
                }
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        // --- 2. HÀM TRA CỨU KHÁCH HÀNG (MỚI) ---
        async function lookupCustomer() {
            const phone = document.getElementById('customerPhone').value.trim();
            const nameDisplay = document.getElementById('customerNameDisplay');
            const pointsDisplay = document.getElementById('customerPointsDisplay');

            if (!phone) {
                currentCustomerId = null;
                nameDisplay.innerText = "Khách lẻ";
                nameDisplay.style.color = "#333";
                pointsDisplay.innerText = "";
                return;
            }

            try {
                // Gọi API tìm kiếm khách hàng
                const res = await axios.get(`${API_BASE}/customer/list?search=${phone}`);
                const customers = res.data.content;

                if (customers.length > 0) {
                    // Tìm thấy khách hàng
                    const cus = customers[0];
                    currentCustomerId = cus.customerId; // Lưu ID quan trọng này lại
                    nameDisplay.innerText = cus.fullName;
                    nameDisplay.style.color = "green";
                    pointsDisplay.innerText = `(${cus.points || 0} điểm)`;
                } else {
                    // Không tìm thấy -> Sẽ tạo mới
                    currentCustomerId = null;
                    nameDisplay.innerText = "Khách mới (Sẽ tạo tự động)";
                    nameDisplay.style.color = "#d48806";
                    pointsDisplay.innerText = "";
                }
            } catch (error) {
                console.error(error);
            }
        }

        // --- 3. RENDER SẢN PHẨM ---
        const grid = document.getElementById('productGrid');
        function renderProducts(list) {
            grid.innerHTML = "";
            if (list.length === 0) {
                grid.innerHTML = '<p style="padding:20px; color:#666">Không tìm thấy sản phẩm</p>';
                return;
            }

            list.forEach(p => {
                const imgUrl = p.imageUrl ? `${API_BASE}/product/images/${p.imageUrl}` : 'https://via.placeholder.com/150';
                const card = document.createElement('div');
                card.className = 'product-card';
                card.onclick = () => addToCart(p.productId);
                card.innerHTML = `
                <img src="${imgUrl}" class="product-img" alt="${p.productName}">
                <div class="product-info">
                    <div class="product-name" title="${p.productName}">${p.productName}</div>
                    <div class="product-price">${formatMoney(p.price)}</div>
                    <div style="font-size:11px; color:#888">Kho: ${p.stockQuantity}</div>
                </div>
            `;
                grid.appendChild(card);
            });
        }

        // --- 4. LOGIC GIỎ HÀNG ---
        function addToCart(id) {
            const product = allProducts.find(p => p.productId === id);
            if (product.stockQuantity <= 0) { alert("Sản phẩm đã hết hàng!"); return; }

            const existingItem = cart.find(item => item.productId === id);
            let currentQtyInCart = existingItem ? existingItem.qty : 0;
            if (currentQtyInCart + 1 > product.stockQuantity) { alert("Không đủ hàng trong kho!"); return; }

            if (existingItem) existingItem.qty++;
            else cart.push({ ...product, qty: 1 });
            renderCart();
        }

        function renderCart() {
            const cartContainer = document.getElementById('cartItems');
            if (cart.length === 0) {
                cartContainer.innerHTML = '<div style="text-align: center; color: #999; margin-top: 50px;">Chưa có sản phẩm nào</div>';
                updateTotals(0); return;
            }
            cartContainer.innerHTML = "";
            let subTotal = 0;
            cart.forEach(item => {
                subTotal += item.price * item.qty;
                const div = document.createElement('div');
                div.className = 'cart-item';
                div.innerHTML = `
                <div class="item-left">
                    <div class="item-name">${item.productName}</div>
                    <div class="item-price">${formatMoney(item.price)}</div>
                </div>
                <div class="item-controls">
                    <button class="qty-btn" onclick="changeQty(${item.productId}, -1)">-</button>
                    <span>${item.qty}</span>
                    <button class="qty-btn" onclick="changeQty(${item.productId}, 1)">+</button>
                    <i class="fas fa-trash remove-btn" onclick="removeItem(${item.productId})"></i>
                </div>
            `;
                cartContainer.appendChild(div);
            });
            cartContainer.scrollTop = cartContainer.scrollHeight;
            updateTotals(subTotal);
        }

        function changeQty(id, delta) {
            const item = cart.find(i => i.productId === id);
            if (item) {
                if (delta > 0 && item.qty >= item.stockQuantity) { alert("Đã đạt giới hạn tồn kho!"); return; }
                item.qty += delta;
                if (item.qty <= 0) removeItem(id);
                else renderCart();
            }
        }

        function removeItem(id) {
            cart = cart.filter(i => i.productId !== id);
            renderCart();
        }

        function clearCart() {
            if (cart.length > 0 && confirm('Hủy đơn hàng hiện tại?')) {
                cart = [];
                currentCustomerId = null; // Reset khách
                document.getElementById('customerPhone').value = '';
                document.getElementById('customerNameDisplay').innerText = 'Khách lẻ';
                document.getElementById('customerNameDisplay').style.color = '#333';
                document.getElementById('customerPointsDisplay').innerText = '';
                renderCart();
                document.getElementById('discountInput').value = 0;
            }
        }

        // --- 5. TÍNH TOÁN ---
        function updateTotals(subTotal) {
            document.getElementById('subTotal').innerText = formatMoney(subTotal);
            calculateTotal();
        }

        function calculateTotal() {
            let subTotal = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
            const discountPercent = parseInt(document.getElementById('discountInput').value) || 0;
            const discountAmount = subTotal * (discountPercent / 100);
            const finalTotal = subTotal - discountAmount;
            document.getElementById('grandTotal').innerText = formatMoney(finalTotal);
        }

        // --- 6. THANH TOÁN (SỬA ĐỔI QUAN TRỌNG) ---
        async function checkout() {
            if (cart.length === 0) { alert("Giỏ hàng đang trống!"); return; }

            const phone = document.getElementById('customerPhone').value;
            const customerName = phone ? "Khách hàng " + phone : "Khách lẻ";

            // SỬA 5: Gửi kèm customerId nếu đã tìm thấy
            const orderData = {
                customerId: currentCustomerId, // Backend sẽ ưu tiên dùng ID này
                customerName: customerName,
                customerPhone: phone,
                paymentMethod: "CASH",
                items: cart.map(item => ({
                    productId: item.productId,
                    quantity: item.qty
                }))
            };

            try {
                document.getElementById('loadingSpinner').style.display = 'flex';
                const res = await axios.post(`${API_BASE}/order/create`, orderData);

                alert(`✅ Thanh toán thành công!\nMã đơn hàng: ${res.data.substring(res.data.lastIndexOf(':') + 1)}`);

                // Reset
                cart = [];
                currentCustomerId = null;
                document.getElementById('customerPhone').value = '';
                document.getElementById('customerNameDisplay').innerText = 'Khách lẻ';
                document.getElementById('customerPointsDisplay').innerText = '';
                renderCart();
                document.getElementById('discountInput').value = 0;

                fetchProductsFromAPI();
            } catch (error) {
                console.error(error);
                alert("❌ Lỗi thanh toán: " + (error.response?.data || error.message));
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        // --- 7. TIỆN ÍCH ---
        function formatMoney(number) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(number);
        }

        function handleSearch() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allProducts.filter(p =>
                p.productName.toLowerCase().includes(keyword) ||
                p.sku.toLowerCase().includes(keyword)
            );
            renderProducts(filtered);
        }

        function filterCategory(catId) {
            document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            if (catId === 'all') renderProducts(allProducts);
            else {
                const filtered = allProducts.filter(p => p.category && p.category.categoryId === catId);
                renderProducts(filtered);
            }
        }

        document.addEventListener('DOMContentLoaded', fetchProductsFromAPI);
    </script>
</body>

</html>