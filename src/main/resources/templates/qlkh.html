<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Khách Hàng - XYZ Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .table th { background-color: #f1f3f5; }
        .points-badge { background-color: #ffc107; color: #000; font-weight: bold; border-radius: 20px; padding: 5px 10px; }
        .loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); display: none; justify-content: center; align-items: center; z-index: 9999; }
    </style>
</head>
<body>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary"><i class="fas fa-users"></i> Danh Sách Khách Hàng</h2>
        <button class="btn btn-primary" onclick="openModal('ADD')">
            <i class="fas fa-user-plus"></i> Thêm Khách Hàng
        </button>
    </div>

    <div class="card p-3 mb-3">
        <div class="row">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" id="searchInput" class="form-control" placeholder="Tìm theo tên hoặc số điện thoại...">
                    <button class="btn btn-outline-secondary" onclick="fetchCustomers()">
                        <i class="fas fa-search"></i> Tìm kiếm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body p-0">
            <table class="table table-hover mb-0 align-middle">
                <thead>
                    <tr>
                        <th>#ID</th>
                        <th>Họ và Tên</th>
                        <th>Số Điện Thoại</th>
                        <th>Địa Chỉ</th>
                        <th>Điểm Tích Lũy</th>
                        <th class="text-center">Hành Động</th>
                    </tr>
                </thead>
                <tbody id="customerTableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="d-flex justify-content-center mt-3 align-items-center gap-2">
        <button class="btn btn-sm btn-light border" onclick="changePage(-1)" id="btnPrev">Trước</button>
        <span id="pageInfo" class="fw-bold text-muted">Trang 1</span>
        <button class="btn btn-sm btn-light border" onclick="changePage(1)" id="btnNext">Sau</button>
    </div>
</div>

<div class="modal fade" id="customerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle">Thêm Khách Hàng</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="customerForm">
                    <input type="hidden" id="customerId">
                    <div class="mb-3">
                        <label>Họ và Tên <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="fullName" required>
                    </div>
                    <div class="mb-3">
                        <label>Số Điện Thoại <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="phoneNumber" required>
                        <small class="text-muted">Dùng để tích điểm và tra cứu.</small>
                    </div>
                    <div class="mb-3">
                        <label>Địa Chỉ</label>
                        <textarea class="form-control" id="address" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="saveCustomer()">Lưu Thông Tin</button>
            </div>
        </div>
    </div>
</div>

<div class="loading" id="loadingSpinner">
    <div class="spinner-border text-primary" role="status"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- CẤU HÌNH API ---
    const API_BASE = 'http://web-quan-ly-ban-hang.railway.internal';
    axios.defaults.withCredentials = true;

    let currentPage = 0;
    let totalPages = 0;
    const modalElement = new bootstrap.Modal(document.getElementById('customerModal'));

    // --- 1. LẤY DANH SÁCH KHÁCH HÀNG ---
    function fetchCustomers() {
        showLoading(true);
        const search = document.getElementById('searchInput').value;
        
        axios.get(`${API_BASE}/customer/list`, {
            params: { page: currentPage, size: 10, search: search }
        })
        .then(res => {
            renderTable(res.data.content);
            totalPages = res.data.totalPages;
            updatePagination();
        })
        .catch(err => {
            console.error(err);
            if (err.response?.status === 401) alert("Vui lòng đăng nhập!");
        })
        .finally(() => showLoading(false));
    }

    // --- 2. RENDER BẢNG ---
    function renderTable(data) {
        const tbody = document.getElementById('customerTableBody');
        tbody.innerHTML = '';

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">Không tìm thấy khách hàng nào</td></tr>';
            return;
        }

        data.forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${c.customerId}</td>
                <td class="fw-bold text-primary">${c.fullName}</td>
                <td>${c.phoneNumber}</td>
                <td>${c.address || '-'}</td>
                <td><span class="points-badge"><i class="fas fa-star"></i> ${c.points || 0}</span></td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-primary me-1" onclick='openModal("EDIT", ${JSON.stringify(c)})'>
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCustomer(${c.customerId})">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- 3. MỞ MODAL ---
    function openModal(mode, customer = null) {
        document.getElementById('customerForm').reset();
        const title = document.getElementById('modalTitle');
        
        if (mode === 'ADD') {
            title.innerText = "Thêm Khách Hàng Mới";
            document.getElementById('customerId').value = '';
        } else {
            title.innerText = "Cập Nhật Thông Tin";
            document.getElementById('customerId').value = customer.customerId;
            document.getElementById('fullName').value = customer.fullName;
            document.getElementById('phoneNumber').value = customer.phoneNumber;
            document.getElementById('address').value = customer.address || '';
        }
        modalElement.show();
    }

    // --- 4. LƯU DỮ LIỆU ---
    function saveCustomer() {
        const id = document.getElementById('customerId').value;
        const data = {
            fullName: document.getElementById('fullName').value,
            phoneNumber: document.getElementById('phoneNumber').value,
            address: document.getElementById('address').value
        };

        if (!data.fullName || !data.phoneNumber) {
            alert("Vui lòng nhập tên và số điện thoại!");
            return;
        }

        showLoading(true);
        let apiCall;

        if (id) {
            apiCall = axios.put(`${API_BASE}/customer/update/${id}`, data);
        } else {
            apiCall = axios.post(`${API_BASE}/customer/create`, data);
        }

        apiCall.then(() => {
            alert("Lưu thành công!");
            modalElement.hide();
            fetchCustomers();
        })
        .catch(err => alert("Lỗi: " + (err.response?.data || err.message)))
        .finally(() => showLoading(false));
    }

    // --- 5. XÓA KHÁCH HÀNG ---
    function deleteCustomer(id) {
        if (confirm("Bạn có chắc muốn xóa khách hàng này?")) {
            showLoading(true);
            axios.delete(`${API_BASE}/customer/delete/${id}`)
                .then(() => {
                    alert("Đã xóa!");
                    fetchCustomers();
                })
                .catch(err => alert("Lỗi: " + err.message))
                .finally(() => showLoading(false));
        }
    }

    // --- TIỆN ÍCH ---
    function changePage(delta) {
        const newPage = currentPage + delta;
        if (newPage >= 0 && newPage < totalPages) {
            currentPage = newPage;
            fetchCustomers();
        }
    }

    function updatePagination() {
        document.getElementById('pageInfo').innerText = `Trang ${currentPage + 1} / ${totalPages}`;
        document.getElementById('btnPrev').disabled = currentPage === 0;
        document.getElementById('btnNext').disabled = currentPage >= totalPages - 1;
    }

    function showLoading(show) {
        document.getElementById('loadingSpinner').style.display = show ? 'flex' : 'none';
    }

    // KHỞI CHẠY
    document.addEventListener('DOMContentLoaded', fetchCustomers);

</script>
</body>
</html>