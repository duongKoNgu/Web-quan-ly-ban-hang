<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Đơn Hàng - XYZ Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .table th { background-color: #f1f3f5; }
        .order-id { font-weight: bold; color: #1890ff; }
        .total-amount { font-weight: bold; color: #d48806; }
        .loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); display: none; justify-content: center; align-items: center; z-index: 9999; }
        
        /* Style cho Modal chi tiết */
        .invoice-box { border: 1px solid #eee; padding: 15px; border-radius: 5px; background: #fff; }
        .invoice-header { border-bottom: 2px dashed #ddd; margin-bottom: 15px; padding-bottom: 10px; }
        .invoice-total { border-top: 2px dashed #ddd; margin-top: 15px; padding-top: 10px; font-size: 1.2em; text-align: right; }
    </style>
</head>
<body>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary"><i class="fas fa-file-invoice-dollar"></i> Lịch Sử Đơn Hàng</h2>
        <div>
            </div>
    </div>

    <div class="card p-3 mb-3 shadow-sm border-0">
        <div class="row">
            <div class="col-md-5">
                <div class="input-group">
                    <input type="text" id="searchInput" class="form-control" placeholder="Tìm tên khách hoặc SĐT..." onkeyup="if(event.key === 'Enter') fetchOrders()">
                    <button class="btn btn-primary" onclick="fetchOrders()">
                        <i class="fas fa-search"></i> Tìm kiếm
                    </button>
                </div>
            </div>
            <div class="col-md-7 text-end">
                <button class="btn btn-outline-secondary" onclick="fetchOrders()">
                    <i class="fas fa-sync-alt"></i> Làm mới
                </button>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Mã Đơn</th>
                        <th>Ngày Tạo</th>
                        <th>Khách Hàng</th>
                        <th>Nhân Viên</th>
                        <th>Phương Thức</th>
                        <th>Tổng Tiền</th>
                        <th class="text-center">Chi Tiết</th>
                    </tr>
                </thead>
                <tbody id="orderTableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="d-flex justify-content-center mt-3 align-items-center gap-2">
        <button class="btn btn-sm btn-light border" onclick="changePage(-1)" id="btnPrev">Trước</button>
        <span id="pageInfo" class="fw-bold text-muted">Trang 1</span>
        <button class="btn btn-sm btn-light border" onclick="changePage(1)" id="btnNext">Sau</button>
    </div>
</div>

<div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi Tiết Đơn Hàng <span id="modalOrderId" class="text-primary"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <div class="invoice-box">
                    <div class="invoice-header">
                        <div class="row">
                            <div class="col-6">
                                <strong>Ngày:</strong> <span id="modalDate"></span><br>
                                <strong>Nhân viên:</strong> <span id="modalStaff"></span>
                            </div>
                            <div class="col-6 text-end">
                                <strong>Khách hàng:</strong> <span id="modalCustomer"></span><br>
                                <strong>SĐT:</strong> <span id="modalPhone"></span>
                            </div>
                        </div>
                    </div>

                    <table class="table table-sm table-bordered">
                        <thead>
                            <tr class="table-secondary">
                                <th>Sản phẩm</th>
                                <th class="text-center">SL</th>
                                <th class="text-end">Đơn giá</th>
                                <th class="text-end">Thành tiền</th>
                            </tr>
                        </thead>
                        <tbody id="modalItemsBody">
                            </tbody>
                    </table>

                    <div class="invoice-total">
                        <strong>Tổng cộng: <span id="modalTotal" class="text-danger"></span></strong>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="alert('Tính năng in đang phát triển!')">
                    <i class="fas fa-print"></i> In Hóa Đơn
                </button>
            </div>
        </div>
    </div>
</div>

<div class="loading" id="loadingSpinner">
    <div class="spinner-border text-primary" role="status"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_BASE = 'http://localhost:8080';
    axios.defaults.withCredentials = true;
    
    let currentPage = 0;
    let totalPages = 0;
    const detailModal = new bootstrap.Modal(document.getElementById('orderDetailModal'));

    // --- 1. LẤY DANH SÁCH ĐƠN HÀNG ---
    async function fetchOrders() {
        showLoading(true);
        const search = document.getElementById('searchInput').value;

        try {
            const res = await axios.get(`${API_BASE}/order/list`, {
                params: {
                    page: currentPage,
                    size: 10,
                    search: search
                }
            });
            
            renderTable(res.data.content);
            totalPages = res.data.totalPages;
            updatePagination();

        } catch (error) {
            console.error(error);
            if (error.response?.status === 401) {
                alert("Hết phiên đăng nhập!");
                window.location.href = 'login.html';
            } else {
                alert("Lỗi tải dữ liệu!");
            }
        } finally {
            showLoading(false);
        }
    }

    // --- 2. RENDER BẢNG ---
    function renderTable(orders) {
        const tbody = document.getElementById('orderTableBody');
        tbody.innerHTML = '';

        if (orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">Chưa có đơn hàng nào</td></tr>';
            return;
        }

        orders.forEach(o => {
            const tr = document.createElement('tr');
            
            // Xử lý dữ liệu null (Khách lẻ)
            const customerName = o.customer ? o.customer.fullName : '<span class="text-muted">Khách lẻ</span>';
            const staffName = o.user ? o.user.fullName : 'Admin';
            const dateStr = new Date(o.orderDate).toLocaleString('vi-VN');

            tr.innerHTML = `
                <td class="order-id">#${o.orderId}</td>
                <td>${dateStr}</td>
                <td>${customerName}</td>
                <td>${staffName}</td>
                <td><span class="badge bg-info text-dark">${o.paymentMethod || 'CASH'}</span></td>
                <td class="total-amount">${formatMoney(o.totalAmount)}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-primary" onclick="viewDetail(${o.orderId})">
                        <i class="fas fa-eye"></i> Xem
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- 3. XEM CHI TIẾT (QUAN TRỌNG) ---
    async function viewDetail(orderId) {
        showLoading(true);
        try {
            // Gọi API lấy chi tiết 1 đơn hàng
            const res = await axios.get(`${API_BASE}/order/${orderId}`);
            const order = res.data;

            // 1. Điền thông tin chung vào Header Modal
            document.getElementById('modalOrderId').innerText = '#' + order.orderId;
            document.getElementById('modalDate').innerText = new Date(order.orderDate).toLocaleString('vi-VN');
            document.getElementById('modalStaff').innerText = order.user ? order.user.fullName : 'N/A';
            document.getElementById('modalCustomer').innerText = order.customer ? order.customer.fullName : 'Khách lẻ';
            document.getElementById('modalPhone').innerText = order.customer ? order.customer.phoneNumber : '-';
            document.getElementById('modalTotal').innerText = formatMoney(order.totalAmount);

            // 2. Render danh sách sản phẩm (Order Details)
            const itemsBody = document.getElementById('modalItemsBody');
            itemsBody.innerHTML = '';
            
            if (order.orderDetails && order.orderDetails.length > 0) {
                order.orderDetails.forEach(item => {
                    const productName = item.product ? item.product.productName : 'Sản phẩm đã xóa';
                    const totalLine = item.quantity * item.unitPrice;

                    const row = `
                        <tr>
                            <td>${productName}</td>
                            <td class="text-center">${item.quantity}</td>
                            <td class="text-end">${formatMoney(item.unitPrice)}</td>
                            <td class="text-end fw-bold">${formatMoney(totalLine)}</td>
                        </tr>
                    `;
                    itemsBody.innerHTML += row;
                });
            }

            // Mở Modal
            detailModal.show();

        } catch (error) {
            alert("Không thể tải chi tiết đơn hàng!");
        } finally {
            showLoading(false);
        }
    }

    // --- TIỆN ÍCH ---
    function formatMoney(num) {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(num);
    }

    function changePage(delta) {
        const newPage = currentPage + delta;
        if (newPage >= 0 && newPage < totalPages) {
            currentPage = newPage;
            fetchOrders();
        }
    }

    function updatePagination() {
        document.getElementById('pageInfo').innerText = `Trang ${currentPage + 1} / ${totalPages}`;
        document.getElementById('btnPrev').disabled = currentPage === 0;
        document.getElementById('btnNext').disabled = currentPage >= totalPages - 1;
    }

    function showLoading(show) {
        document.getElementById('loadingSpinner').style.display = show ? 'flex' : 'none';
    }

    // Init
    document.addEventListener('DOMContentLoaded', fetchOrders);

</script>
</body>
</html>